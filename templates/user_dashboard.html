<!DOCTYPE html>
<html lang="en">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>User Dashboard</title>
    </head>
<body>
<h2>Welcome, {{ current_user.full_name }}</h2>

<h3>Available Parking Lots</h3>
{% for lot in lots %}
    <div>
        <strong>{{ lot.name }}</strong> ({{ lot.address }})<br>
        â‚¹{{ lot.price_per_hour }}/hr | Spots Available:
        {{ lot.spots | selectattr('status', 'equalto', 'A') | list | length }} <br>
        <a href="{{ url_for('user.reserve_spot', lot_id=lot.id) }}">Reserve Spot</a>
    </div>
{% endfor %}

<h3>Your Reservations</h3>
{% for r in reservations %}
    <div style="margin-bottom: 10px;">
        Spot ID: {{ r.spot_id }} | Lot: {{ r.spot.lot.name }}<br>
        Start: {{ r.start_time or 'Not started' }}<br>
        End: {{ r.end_time or 'Not ended' }}<br>
        {% if r.duration %}
            Duration: {{ r.duration }}<br>
        {% endif %}
        {% if not r.start_time %}
            <a href="{{ url_for('user.occupy_spot', reservation_id=r.id) }}">Occupy</a>
        {% elif not r.end_time %}
            <a href="{{ url_for('user.release_spot', reservation_id=r.id) }}">Release</a>
        {% endif %}
    </div>
{% endfor %}

<h3>Reservation History Chart</h3>
<canvas id="historyChart" width="400" height="200"></canvas>
<!-- Include Chart.js from CDN -->
<script>
const labels = {{ chart_data | tojson | safe }};
const data = {
    labels: labels,
    datasets: [{
        label: 'Reservations',
        data: labels.map(() => 1),
        backgroundColor: '#60a5fa'
    }]
};

window.addEventListener('DOMContentLoaded', function() {
    new Chart(document.getElementById('historyChart'), {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'No. of Reservations' } },
                x: { title: { display: true, text: 'Date' } }
            }
        }
    });
});
</script>
<br>



<form method="POST" action="{{ url_for('user.logout') }}">
    <button type="submit">Logout</button>
</form>
</body>
</html>